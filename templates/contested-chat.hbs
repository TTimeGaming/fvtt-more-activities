<div class="dnd5e2 chat-card activation-card">
    <section class="card-header description collapsible">
        <header class="summary">
            <img class="gold-icon" src="{{ item.img }}" alt="{{ item.name }}">
            <div class="name-stacked border">
                <span class="title">{{ item.name }}</span>
                <span class="subtitle">{{localize "DND5E.ACTIVITY.MESSAGE.contested.subtitle"}}</span>
            </div>
        </header>
    </section>

    <div class="card-content">
        <div class="contested-check">
            <!-- Attacker Section -->
            <div class="contest-side attacker-side">
                <h4>{{ attackerLabel }}</h4>
                
                {{#if attackerRoll}}
                    <div class="roll-result">
                        <div class="dice-total">{{ attackerRoll.total }}</div>
                    </div>
                {{else}}
                    <div class="roll-buttons">
                        {{#each attackerOptions as |option|}}
                        <button class="contested-roll-button" data-side="attacker" data-option="{{ option.key }}">
                            {{ option.label }}
                        </button>
                        {{/each}}
                    </div>
                {{/if}}
            </div>

            <!-- Defender Section -->
            <div class="contest-side defender-side">
                <h4>{{ defenderLabel }}</h4>

                {{#if hasDefenderSelection}}
                <div class="defender-selection">
                    <label for="defender-select">Select Defender:</label>
                    <select id="defender-select" name="selectedDefender">
                        <option value="">-- Choose Defender --</option>

                        {{#if defendersData.targets.length}}
                        <optgroup label="Targeted Actors">
                            {{#each defendersData.targets as |defender|}}
                            <option value="{{ defender.id }}" {{#if (eq defender.id ../defendersData.selectedDefenderId)}}selected{{/if}}>
                                {{ defender.name }}
                            </option>
                            {{/each}}
                        </optgroup>
                        {{/if}}

                        {{#if (and isGM defendersData.allTokens.length)}}
                        <optgroup label="Scene Tokens">
                            {{#each defendersData.allTokens as |defender|}}
                            <option value="{{ defender.id }}" {{#if (eq defender.id ../defendersData.selectedDefenderId)}}selected{{/if}}>
                                {{ defender.name }}
                            </option>
                            {{/each}}
                        </optgroup>
                        {{/if}}

                        {{#if (and (or allowPlayerTargeting isGM) defendersData.playerCharacters.length)}}
                        <optgroup label="{{#if isGM}}Player{{else}}Your{{/if}} Characters">
                            {{#each defendersData.playerCharacters as |defender|}}
                            <option value="{{ defender.id }}" {{#if (eq defender.id ../defendersData.selectedDefenderId)}}selected{{/if}}>
                                {{ defender.name }}
                            </option>
                            {{/each}}
                        </optgroup>
                        {{/if}}

                        {{#if (and (or allowPlayerTargeting isGM) defendersData.nonPlayerCharacters.length)}}
                        <optgroup label="{{#if isGM}}Player{{else}}Your{{/if}} NPCs">
                            {{#each defendersData.nonPlayerCharacters as |defender|}}
                            <option value="{{ defender.id }}" {{#if (eq defender.id ../defendersData.selectedDefenderId)}}selected{{/if}}>
                                {{ defender.name }}
                            </option>
                            {{/each}}
                        </optgroup>
                        {{/if}}
                    </select>
                </div>
                {{/if}}
                
                {{#if defenderRoll}}
                    <div class="roll-result">
                        <div class="dice-total">{{ defenderRoll.total }}</div>
                    </div>
                {{else}}
                    {{#if (or selectedDefender (not hasDefenderSelection))}}
                    <div class="roll-buttons">
                        {{#each defenderOptions as |option|}}
                        <button class="contested-roll-button" data-side="defender" data-option="{{ option.key }}" {{#unless ../selectedDefender}}{{#if ../hasDefenderSelection}}disabled{{/if}}{{/unless}}>
                            {{ option.label }}
                        </button>
                        {{/each}}
                    </div>
                    {{else}}
                    <div class="roll-buttons">
                        <p class="hint">{{localize "DND5E.ACTIVITY.MESSAGE.contested.defender"}}</p>
                    </div>
                    {{/if}}
                {{/if}}
            </div>
        </div>

        <!-- Result Section -->
        {{#if result}}
        <div class="contest-result">
            {{#if (eq result "attacker")}}
                <div class="result-message winner-attacker">
                    <strong>{{localize "DND5E.ACTIVITY.MESSAGE.contested.result.victory" side=attackerLabel}}</strong>
                    ({{ attackerRoll.total }} vs {{ defenderRoll.total }})
                </div>
            {{else if (eq result "defender")}}
                <div class="result-message winner-defender">
                    <strong>{{localize "DND5E.ACTIVITY.MESSAGE.contested.result.victory" side=defenderLabel}}</strong>
                    ({{ defenderRoll.total }} vs {{ attackerRoll.total }})
                </div>
            {{else if (eq result "tie")}}
                <div class="result-message tie">
                    <strong>{{localize "DND5E.ACTIVITY.MESSAGE.contested.result.tie"}}</strong>
                    ({{ attackerRoll.total }} vs {{ defenderRoll.total }})
                </div>
            {{else if (eq result "reroll")}}
                <div class="result-message reroll">
                    <strong>{{localize "DND5E.ACTIVITY.MESSAGE.contested.result.reroll"}}</strong>
                    ({{ attackerRoll.total }} vs {{ defenderRoll.total }})
                </div>
                <button class="contested-reroll-button" data-activity-id="{{ activity.id }}" data-itemid="{{ item.id }}" data-actor-id="{{ actor.id }}">
                    Re-Roll
                </button>
            {{/if}}
        </div>
        {{/if}}
    </div>
</div>
