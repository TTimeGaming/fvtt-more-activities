<section class="tab activity-{{ tab.id }} {{ tab.cssClass }}" data-tab="{{ tab.id }}" data-group="{{ tab.group }}">
    <fieldset class="collapsible-fieldset" data-expanded="true" data-fieldset-id="grant-configuration">
        <legend class="collapsible-legend">
            <i class="fas fa-chevron-down collapse-arrow"></i>
            <label> Configuration </label>
        </legend>

        <div class="fieldset-content">
            <div class="form-group stacked">
                <label>{{localize "DND5E.ACTIVITY.FIELDS.grant.grantAll.label"}}</label>
                <div class="form-fields">
                    <dnd5e-checkbox name="grantAll" {{#if grantAll}}checked{{/if}}></dnd5e-checkbox>
                </div>
                <p class="hint">{{localize "DND5E.ACTIVITY.FIELDS.grant.grantAll.hint"}}</p>
            </div>

            <div class="form-group stacked indented">
                <label>{{localize "DND5E.ACTIVITY.FIELDS.grant.count.label"}}</label>
                <div class="form-fields">
                    <input type="text" name="count" value="{{ count }}" placeholder="Amount to Grant" {{#if grantAll}}disabled{{/if}}>
                </div>
                <p class="hint"><abbr title="{{localize "DND5E.ACTIVITY.FIELDS.grant.rollFormula.label"}}"><i class="fas fa-calculator"></i></abbr>&emsp;{{localize "DND5E.ACTIVITY.FIELDS.grant.count.hint"}}</p>
            </div>

            <div class="form-group stacked indented">
                <label>{{localize "DND5E.ACTIVITY.FIELDS.grant.swappable.label"}}</label>
                <div class="form-fields">
                    <dnd5e-checkbox name="swappable" {{#if swappable}}checked{{/if}} {{#if grantAll}}disabled{{/if}}></dnd5e-checkbox>
                </div>
                <p class="hint">{{localize "DND5E.ACTIVITY.FIELDS.grant.swappable.hint"}}</p>
            </div>

            <div class="form-group stacked">
                <label>Convert Spells to Scrolls</label>
                <div class="form-fields">
                    <dnd5e-checkbox name="spellsAsScrolls" {{#if spellsAsScrolls}}checked{{/if}}></dnd5e-checkbox>
                </div>
                <p class="hint">Grant spells as scrolls instead of adding to the spellbook</p>
            </div>
        </div>
    </fieldset>

    <fieldset class="collapsible-fieldset" data-expanded="true" data-fieldset-id="cost-groups">
        <legend class="collapsible-legend" style="display: flex; gap: 0.25rem;">
            <i class="fas fa-chevron-down collapse-arrow"></i>
            <label> Cost Groups </label>
            <button type="button" class="add-cost-group unbutton control-button" data-tooltip aria-label="Add Cost Group">
                <i class="fas fa-plus"></i>
            </button>
        </legend>

        <div class="fieldset-content">
            {{#if costGroups.length}}
            {{#each costGroups as |group|}}
            <fieldset class="collapsible-fieldset" data-expanded="true" data-fieldset-id="cost-group-{{ group.index }}">
                <legend class="collapsible-legend" style="display: flex; gap: 0.25rem;">
                    <i class="fas fa-chevron-down collapse-arrow"></i>
                    <label> {{ group.name }}</label>
                    <button type="button" class="remove-cost-group unbutton control-button" data-tooltip aria-label="Remove Cost Group" data-index="{{ group.index }}" style="width: 26px;">
                        <i class="fas fa-trash"></i>
                    </button>
                </legend>

                <div class="fieldset-content">
                    <div class="form-group">
                        <label>Name</label>
                        <div class="form-fields">
                            <input type="text" name="costGroupName" value="{{ group.name }}" placeholder="Cost Group" data-index="{{ group.index }}">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Type</label>
                        <div class="form-fields">
                            <select name="costType" data-index="{{ group.index }}">
                                <option value="currency" {{#if (eq group.type "currency")}}selected{{/if}}>Currency</option>
                                <option value="itemUses" {{#if (eq group.type "itemUses")}}selected{{/if}}>Item Uses</option>
                                <option value="itemConsume" {{#if (eq group.type "itemConsume")}}selected{{/if}}>Consume Item</option>
                            </select>
                        </div>
                    </div>

                    {{#if (eq group.type "currency")}}
                        <div class="form-group stacked">
                            <label>Base Cost</label>
                            <div class="form-fields">
                                <input type="text" name="baseCurrencyAmount" value="{{ group.baseCurrencyAmount }}" placeholder="0" data-index="{{ group.index }}">
                                <select name="baseCurrencyCoin" data-index="{{ group.index }}">
                                    {{#each ../currencyOptions as |currency|}}
                                    <option value="{{ currency }}" {{#if (eq group.baseCurrencyCoin currency)}}selected{{/if}}>{{ currency }}</option>
                                    {{/each}}
                                </select>
                            </div>
                            <p class="hint"><abbr title="{{localize "DND5E.ACTIVITY.FIELDS.grant.rollFormula.label"}}"><i class="fas fa-calculator"></i></abbr>&emsp;Base cost for all items (added to individual costs)</p>
                        </div>

                        <div class="form-group stacked">
                            <label>Cost per Spell Level</label>
                            <div class="form-fields">
                                <input type="text" name="spellCurrencyAmount" value="{{ group.spellCurrencyAmount }}" placeholder="0" data-index="{{ group.index }}">
                                <select name="spellCurrencyCoin" data-index="{{ group.index }}">
                                    {{#each ../currencyOptions as |currency|}}
                                    <option value="{{ currency }}" {{#if (eq group.spellCurrencyCoin currency)}}selected{{/if}}>{{ currency }}</option>
                                    {{/each}}
                                </select>
                            </div>
                            <p class="hint"><abbr title="{{localize "DND5E.ACTIVITY.FIELDS.grant.rollFormula.label"}}"><i class="fas fa-calculator"></i></abbr>&emsp;Additional cost per spell level (spells only)</p>
                        </div>
                    {{/if}}

                    {{#if (or (eq group.type "itemUses") (eq group.type "itemConsume"))}}
                        <div class="form-group stacked">
                            <label>Item</label>
                            <div class="form-fields">
                                <input type="text" name="itemUuid" value="{{ group.itemUuid }}" placeholder="This Item" data-index="{{ group.index }}">
                            </div>
                            <p class="hint">Drag & drop an item or enter UUID</p>
                        </div>

                        <div class="form-group stacked">
                            <label>{{#if (eq group.type "itemUses")}}Uses{{else}}Quantity{{/if}}</label>
                            <div class="form-fields">
                                <input type="text" name="itemAmount" value="{{ group.itemAmount }}" placeholder="1" data-index="{{ group.index }}">
                            </div>
                            <p class="hint"><abbr title="{{localize "DND5E.ACTIVITY.FIELDS.grant.rollFormula.label"}}"><i class="fas fa-calculator"></i></abbr>&emsp;{{#if (eq group.type "itemUses")}}Number of uses to consume{{else}}Quantity to consume{{/if}}</p>
                        </div>
                    {{/if}}
                </div>
            </fieldset>
            {{/each}}
            {{else}}
                <div class="form-group stacked">
                    <p class="hint"><em>No cost groups assigned</em></p>
                </div>
            {{/if}}
        </div>
    </fieldset>

    <fieldset class="collapsible-fieldset" data-expanded="true" data-fieldset-id="grant-items">
        <legend class="collapsible-legend">
            <i class="fas fa-chevron-down collapse-arrow"></i>
            <label> Items </label>
        </legend>

        <div class="fieldset-content">
            <div class="form-group stacked">
                <label>{{localize "DND5E.ACTIVITY.FIELDS.grant.uuid.label"}}</label>
                <div class="form-fields">
                    <input type="text" name="current" value="{{ current }}" placeholder="UUID or drag & drop item here">
                    <button type="button" class="add-item-btn"><i class="fas fa-plus"></i></button>
                </div>
                <p class="hint">{{localize "DND5E.ACTIVITY.FIELDS.grant.uuid.hint"}}</p>
            </div>

            <div class="form-group stacked">
                <label>Items ({{grants.length}}):</label>
                {{#if grants.length}}
                <div class="granted-items">
                    {{#each grants as |item|}}
                    <div class="granted-item">
                        <div class="item-info">
                            {{#if item.isCustomized}}<abbr title="Customized"><i class="customized-indicator fas fa-star"></i></abbr>{{/if}}
                            <img class="gold-icon item-img" src="{{item.img}}" alt="{{item.name}}">
                            <a data-uuid="{{item.uuid}}" class="item-name">{{item.name}}</a>
                        </div>
                        <div class="item-controls">
                            <div class="item-type">{{item.type}}</div>
                            <button type="button" class="item-customize-btn" data-index="{{item.index}}" data-uuid="{{item.uuid}}">
                                <i class="fas fa-cog"></i>
                            </button>
                            <button type="button" class="item-delete-btn" data-index="{{item.index}}" data-uuid="{{item.uuid}}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>

                    <div class="grant-customization" data-index="{{item.index}}" style="display: {{#if item.isOpen}}flex{{else}}none{{/if}};">
                        <fieldset class="collapsible-fieldset" data-expanded="true" data-fieldset-id="item-cost-groups-{{ item.index }}">
                            <legend class="collapsible-legend" style="display: flex; gap: 0.25rem;">
                                <i class="fas fa-chevron-down collapse-arrow"></i>
                                <label> Cost Groups </label>
                                <button type="button" class="add-item-cost-group unbutton control-button" data-tooltip aria-label="Add Cost Group" data-item="{{ item.index }}">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </legend>

                            <div class="fieldset-content">
                                {{#if item.customization.costGroups.length}}
                                {{#each item.customization.costGroups as |group|}}
                                <fieldset class="collapsible-fieldset" data-expanded="true" data-fieldset-id="item-cost-group-{{ item-index }}-{{ group.index }}">
                                    <legend class="collapsible-legend" style="display: flex; gap: 0.25rem;">
                                        <i class="fas fa-chevron-down collapse-arrow"></i>
                                        <label> {{ group.name }}</label>
                                        <button type="button" class="remove-item-cost-group unbutton control-button" data-tooltip aria-label="Remove Cost Group" data-item="{{ item.index }}" data-index="{{ group.index }}" style="width: 26px;">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </legend>

                                    <div class="fieldset-content">
                                        <div class="form-group">
                                            <label>Name</label>
                                            <div class="form-fields">
                                                <input type="text" name="itemCostGroupName" value="{{ group.name }}" placeholder="Cost Group" data-item="{{ item.index }}" data-index="{{ group.index }}">
                                            </div>
                                        </div>

                                        <div class="form-group">
                                            <label>Type</label>
                                            <div class="form-fields">
                                                <select name="itemCostType" data-item="{{ item.index }}" data-index="{{ group.index }}">
                                                    <option value="currency" {{#if (eq group.type "currency")}}selected{{/if}}>Currency</option>
                                                    <option value="itemUses" {{#if (eq group.type "itemUses")}}selected{{/if}}>Item Uses</option>
                                                    <option value="itemConsume" {{#if (eq group.type "itemConsume")}}selected{{/if}}>Consume Item</option>
                                                </select>
                                            </div>
                                        </div>

                                        {{#if (eq group.type "currency")}}
                                            <div class="form-group stacked">
                                                <label>Base Cost</label>
                                                <div class="form-fields">
                                                    <input type="text" name="itemBaseCurrencyAmount" value="{{ group.baseCurrencyAmount }}" placeholder="0" data-item="{{ item.index }}" data-index="{{ group.index }}">
                                                    <select name="itemBaseCurrencyCoin" data-item="{{ item.index }}" data-index="{{ group.index }}">
                                                        {{#each ../../currencyOptions as |currency|}}
                                                        <option value="{{ currency }}" {{#if (eq group.baseCurrencyCoin currency)}}selected{{/if}}>{{ currency }}</option>
                                                        {{/each}}
                                                    </select>
                                                </div>
                                                <p class="hint"><abbr title="{{localize "DND5E.ACTIVITY.FIELDS.grant.rollFormula.label"}}"><i class="fas fa-calculator"></i></abbr>&emsp;Individual cost for item</p>
                                            </div>

                                            {{#if item.isSpell}}
                                            <div class="form-group stacked">
                                                <label>Cost per Spell Level</label>
                                                <div class="form-fields">
                                                    <input type="text" name="itemSpellCurrencyAmount" value="{{ group.spellCurrencyAmount }}" placeholder="0" data-item="{{ item.index }}" data-index="{{ group.index }}">
                                                    <select name="itemSpellCurrencyCoin" data-item="{{ item.index }}" data-index="{{ group.index }}">
                                                        {{#each ../../currencyOptions as |currency|}}
                                                        <option value="{{ currency }}" {{#if (eq group.spellCurrencyCoin currency)}}selected{{/if}}>{{ currency }}</option>
                                                        {{/each}}
                                                    </select>
                                                </div>
                                                <p class="hint"><abbr title="{{localize "DND5E.ACTIVITY.FIELDS.grant.rollFormula.label"}}"><i class="fas fa-calculator"></i></abbr>&emsp;Individual cost per spell level</p>
                                            </div>
                                            {{/if}}
                                        {{/if}}

                                        {{#if (or (eq group.type "itemUses") (eq group.type "itemConsume"))}}
                                            <div class="form-group stacked">
                                                <label>Item</label>
                                                <div class="form-fields">
                                                    <input type="text" name="itemItemUuid" value="{{ group.itemUuid }}" placeholder="This Item" data-item="{{ item.index }}" data-index="{{ group.index }}">
                                                </div>
                                                <p class="hint">Drag & drop an item or enter UUID</p>
                                            </div>

                                            <div class="form-group stacked">
                                                <label>{{#if (eq group.type "itemUses")}}Uses{{else}}Quantity{{/if}}</label>
                                                <div class="form-fields">
                                                    <input type="text" name="itemItemAmount" value="{{ group.itemAmount }}" placeholder="1" data-item="{{ item.index }}" data-index="{{ group.index }}">
                                                </div>
                                                <p class="hint"><abbr title="{{localize "DND5E.ACTIVITY.FIELDS.grant.rollFormula.label"}}"><i class="fas fa-calculator"></i></abbr>&emsp;{{#if (eq group.type "itemUses")}}Number of uses to consume{{else}}Quantity to consume{{/if}}</p>
                                            </div>
                                        {{/if}}
                                    </div>
                                </fieldset>
                                {{/each}}
                                {{else}}          
                                    <div class="form-group stacked">
                                        <p class="hint"><em>No cost groups assigned</em></p>
                                    </div>
                                {{/if}}
                            </div>
                        </fieldset>

                        <fieldset>
                            <legend><label> Usage Limitations </label></legend>

                            <div class="form-group stacked">
                                <label>Override Uses</label>
                                <div class="form-fields">
                                    <input type="text" name="itemMaxUses" value="{{ item.customization.maxUses }}" placeholder="{{#if item.hasUses}}{{ item.maxUses }}{{else}}Unlimited{{/if}}" data-index="{{item.index}}">
                                </div>
                                <p class="hint"><abbr title="{{localize "DND5E.ACTIVITY.FIELDS.grant.rollFormula.label"}}"><i class="fas fa-calculator"></i></abbr>&emsp;Leave blank to use item default</p>
                            </div>

                            <div class="form-group stacked">
                                <label>Recovery Period</label>
                                <select name="itemRecovery" data-index="{{item.index}}">
                                    {{#each item.recoveryOptions as |option|}}
                                    <option value="{{ option.key }}" {{#if option.selected}}selected{{/if}}>{{ option.label }}</option>
                                    {{/each}}
                                </select>
                            </div>
                        </fieldset>

                        {{#if item.isSpell}}
                        <fieldset>
                            <legend><label> Spell Options </label></legend>

                            <div class="form-group stacked">
                                <label>Grant as Scroll</label>
                                <div class="form-fields">
                                    <div class="tri-state-button-group">
                                    {{#each item.scrollStates as |state|}}
                                    <button type="button" class="scroll-state-btn {{#if state.selected}}active{{/if}}" data-state="{{state.value}}" data-tooltip="{{state.label}}" data-index="{{item.index}}">
                                        <i class="{{state.icon}}"></i>
                                    </button>
                                    {{/each}}
                                </div>
                                </div>
                                <p class="hint">Override global spell scroll setting for this item</p>
                            </div>
                        </fieldset>
                        {{/if}}
                    </div>
                    {{/each}}
                </div>
                {{else}}
                <div class="no-items">{{localize "DND5E.ACTIVITY.FIELDS.grant.none.hint"}}</div>
                {{/if}}
            </div>
        </div>
    </fieldset>
</section>
